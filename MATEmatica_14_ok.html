<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misión Matemática (beta5)</title>
    <style>
        :root {
            --primary-bg: #10101a; --primary-text: #e0e0e0; --card-back-bg: #222230; --card-front-bg: #1a1a28;
            --neon-cyan: #00ffff; --neon-magenta: #ff00ff; --neon-green: #39ff14; --neon-red: #ff1b1b;
            --neon-orange: #ff9900; --neon-yellow: #fff000;
            --font-main: 'Segoe UI', 'Roboto', sans-serif; --font-mono: 'Roboto Mono', 'Consolas', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; overflow: hidden; background-color: var(--primary-bg); color: var(--primary-text); font-family: var(--font-main); }
        #app-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; perspective: 1200px; position: relative; }
        .screen { width: 100%; height: 100%; padding: 2rem; position: absolute; top: 0; left: 0; display: none; flex-direction: column; justify-content: center; align-items: center; gap: 1.5rem; opacity: 0; transform: scale(0.95); transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; }
        .screen.active { display: flex; opacity: 1; transform: scale(1); z-index: 1; }
        .title { font-size: clamp(2.5rem, 5vw, 4rem); font-weight: 300; letter-spacing: 5px; text-align: center; text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan); margin-bottom: 1rem; }
        .title.clickable { cursor: help; user-select: none; }
        .subtitle { font-size: clamp(1.5rem, 3vw, 2rem); font-weight: 300; letter-spacing: 2px; color: var(--neon-cyan); text-shadow: 0 0 5px var(--neon-cyan); }
        .neon-button { padding: 15px 30px; font-size: 1.5rem; color: var(--primary-text); background-color: transparent; border: 2px solid var(--neon-magenta); border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 10px var(--neon-magenta), inset 0 0 5px var(--neon-magenta); transition: all 0.2s ease-in-out; }
        .neon-button:hover, .neon-button:focus { background-color: var(--neon-magenta); color: var(--primary-bg); box-shadow: 0 0 20px var(--neon-magenta), 0 0 40px var(--neon-magenta); outline: none; }
        .neon-button.danger { border-color: var(--neon-red); box-shadow: 0 0 10px var(--neon-red), inset 0 0 5px var(--neon-red); }
        .neon-button.danger:hover, .neon-button.danger:focus { background-color: var(--neon-red); color: var(--primary-bg); box-shadow: 0 0 20px var(--neon-red), 0 0 40px var(--neon-red); }
        .back-button { position: absolute; top: 2rem; left: 2rem; font-size: 1.5rem; cursor: pointer; color: var(--neon-cyan); z-index: 10; }
        .back-button:hover { text-shadow: 0 0 10px var(--neon-cyan); }
        
        #preloader-screen .atom{position:relative;width:120px;height:120px}#preloader-screen .atom::before{content:'';position:absolute;top:50%;left:50%;width:40px;height:40px;margin:-20px 0 0 -20px;border-radius:50%;background-color:var(--neon-cyan);box-shadow:0 0 15px var(--neon-cyan),0 0 30px var(--neon-cyan)}#preloader-screen .electron{position:absolute;width:100%;height:100%;border:3px solid var(--neon-cyan);border-radius:50%;animation:rotate 2s linear infinite}#preloader-screen .electron:nth-child(2){animation-delay:-.67s}#preloader-screen .electron:nth-child(3){animation-delay:-1.33s}@keyframes rotate{from{transform:rotate3d(1,1,1,0deg)}to{transform:rotate3d(1,1,1,360deg)}}.loading-text{letter-spacing:3px;animation:blink 1.5s infinite}@keyframes blink{50%{opacity:.5}}#loading-percentage{font-family:var(--font-mono);font-size:1.2rem;color:var(--neon-cyan);margin-top:1rem;letter-spacing:2px}
        
        /* --- NEW COMPACT PROFILE CARD --- */
        .profile-list{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:1.5rem;width:100%;max-width:1200px}
        .profile-card,.profile-add-card{width:180px;height:230px;background:var(--card-front-bg);border:2px solid var(--neon-cyan);border-radius:10px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:1.2rem 1rem;cursor:pointer;transition:all .3s ease}
        .profile-card:hover,.profile-add-card:hover{transform:scale(1.05);box-shadow:0 0 25px var(--neon-cyan)}
        .profile-name{font-size:1.7rem;font-weight:400;color:var(--neon-cyan);margin-bottom:1.5rem;word-break:break-word}
        .profile-progress-summary{font-family:var(--font-mono);font-size:1.1rem;display:flex;gap:1.2rem}
        .profile-progress-item{display:flex;flex-direction:column;align-items:center}
        .op-symbol{font-size:1.3rem}
        .level-number{margin-top:.5rem;color:var(--neon-yellow)}
        .profile-add-card{border-style:dashed}.profile-add-card .plus-sign{font-size:4rem;font-weight:100;color:var(--neon-cyan)}

        .name-input-container{text-align:center;width:100%;max-width:1000px}.prompt-text{font-size:2rem;margin-bottom:1rem}.name-display{height:80px;font-size:3rem;letter-spacing:10px;border-bottom:3px solid var(--neon-cyan);padding:10px;text-align:center;color:var(--neon-cyan);font-family:var(--font-mono)}.keyboard-grid{display:flex;flex-direction:column;gap:10px;width:100%;max-width:1000px;margin-top:1rem}.keyboard-row{display:flex;justify-content:center;gap:10px}.key{height:60px;flex-grow:1;display:flex;justify-content:center;align-items:center;font-size:1.5rem;border-radius:5px;cursor:pointer;background:#2a2a3a;border:1px solid #444;transition:all .1s ease;user-select:none}.key:hover{background:#4a4a5a;transform:scale(1.05)}.key:active{transform:scale(.95)}.key[data-key-type=letter]{text-transform:lowercase}.key-action{background-color:#4a2a4a;border-color:var(--neon-magenta)}.key-shift.active{background-color:var(--neon-magenta);color:var(--primary-bg)}.key-space{background-color:#1a4a3a;border-color:var(--neon-green);flex-grow:5}.key-double{flex-grow:2}
        
        .mission-header{text-align:center;margin-bottom:2rem}.welcome-back-message{font-size:1.2rem;letter-spacing:1px}.mission-selection-container{display:flex;justify-content:center;align-items:center;gap:3rem}.mission-button{width:200px;height:200px;border:3px solid var(--neon-cyan);border-radius:50%;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;transition:all 0.3s ease}.mission-button:hover{background-color:var(--neon-cyan);color:var(--primary-bg);box-shadow:0 0 25px var(--neon-cyan);transform:scale(1.1)}.mission-button h3{font-size:1.8rem}
        #sublevel-title-container { display: flex; align-items: center; gap: 1.5rem; }
        #sublevel-hof-button { background: none; border: none; cursor: pointer; padding: 0.5rem; }
        #sublevel-hof-button svg { width: 32px; height: 32px; fill: var(--neon-yellow); transition: transform 0.2s ease-in-out; }
        #sublevel-hof-button:hover svg { transform: scale(1.15); filter: drop-shadow(0 0 10px var(--neon-yellow)); }
        .sublevel-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem 2rem; padding: 1rem; width: 100%; max-width: 900px; }
        .sublevel-node{position:relative;height:80px;border:2px solid var(--neon-magenta);border-radius:8px;cursor:pointer;display:flex;justify-content:center;align-items:center;font-size:2rem;font-family:var(--font-mono);transition:all .3s ease}.sublevel-node:hover:not(.locked){background-color:var(--neon-magenta);color:var(--primary-bg);box-shadow:0 0 15px var(--neon-magenta);transform:scale(1.1)}.sublevel-node.locked{border-color:#444;color:#444;background-color:#222;cursor:not-allowed}.sublevel-node.locked::after{display:none}.sublevel-node:not(:nth-child(5n))::after{content:'';position:absolute;left:100%;top:50%;transform:translateY(-50%);height:2px;width:2rem;background-color:rgba(255,0,255,0.5)}.bonus-time-display{color:var(--neon-green);text-shadow:0 0 8px var(--neon-green);margin-top:-1rem;margin-bottom:1rem}

        #game-screen{justify-content:flex-start}.status-bar{width:100%;display:flex;justify-content:space-between;align-items:center;padding:0.5rem 2rem;font-size:1.5rem;background-color:rgba(0,0,0,0.3);flex-shrink:0}.time-bar-container{position:absolute;bottom:0;left:0;width:100%;height:5px;background-color:rgba(255,255,255,0.1)}#time-bar{width:100%;height:100%;background-color:var(--neon-green);transition:width 1s linear,background-color .5s ease}#status-timer.pulsing,#time-bar.pulsing{animation:pulse-red 1s infinite}@keyframes pulse-red{50%{filter:brightness(1.5);box-shadow:0 0 10px var(--neon-red)}}.board-grid{flex-grow:1;width:100%;max-width:1400px;display:grid;gap:1rem;padding:1rem}.card{background-color:transparent;cursor:pointer}.card-inner{position:relative;width:100%;height:100%;transition:transform .6s,box-shadow .3s;transform-style:preserve-3d;border-radius:10px}.card:hover .card-inner{box-shadow:0 0 25px var(--neon-cyan)}.card.flipped .card-inner{transform:rotateY(180deg)}.card-face{position:absolute;width:100%;height:100%;-webkit-backface-visibility:hidden;backface-visibility:hidden;border-radius:10px;display:flex;justify-content:center;align-items:center;font-family:var(--font-mono);font-weight:700;padding:0 10px}.card-front{background:var(--card-front-bg);border:2px solid var(--neon-cyan)}.card-back{background:var(--card-back-bg);transform:rotateY(180deg);font-size:clamp(2rem,10vw,5.5rem)}.card-back.problem{color:var(--neon-orange);text-shadow:0 0 1px #000,0 0 2px #000,0 0 5px #fff,0 0 10px var(--neon-orange),0 0 15px var(--neon-orange)}.card-back.solution{color:var(--neon-yellow);text-shadow:0 0 1px #000,0 0 2px #000,0 0 5px #fff,0 0 10px var(--neon-yellow),0 0 15px var(--neon-yellow)}.card.matched .card-inner{animation:match-pulse .8s ease-out forwards}@keyframes match-pulse{0%{transform:rotateY(180deg) scale(1);opacity:1;box-shadow:0 0 15px var(--neon-green)}50%{transform:rotateY(180deg) scale(1.1);box-shadow:0 0 40px var(--neon-green),inset 0 0 20px var(--neon-green)}100%{transform:rotateY(180deg) scale(.9);opacity:0;box-shadow:0 0 15px var(--neon-green)}}.card.mismatched .card-inner{animation:mismatch-shake .5s ease-in-out}@keyframes mismatch-shake{0%,100%{transform:rotateY(180deg) translateX(0);box-shadow:none}20%,60%{transform:rotateY(180deg) translateX(-10px);box-shadow:0 0 20px var(--neon-red)}40%,80%{transform:rotateY(180deg) translateX(10px);box-shadow:0 0 20px var(--neon-red)}}
        .time-bonus-feedback { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); font-size: 2rem; font-family: var(--font-mono); color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); pointer-events: none; opacity: 0; animation: fade-up-out 1.5s ease-out; }
        @keyframes fade-up-out { 0% { transform: translate(-50%, 0); opacity: 1; } 100% { transform: translate(-50%, -50px); opacity: 0; } }

        .summary-buttons{display:flex;gap:2rem;margin-top:1rem}.summary-title-lost{color:var(--neon-red);text-shadow:0 0 10px var(--neon-red)}#new-record-subtitle{color:var(--neon-yellow);text-shadow:0 0 10px var(--neon-yellow);font-size:1.8rem;animation:blink 1s infinite}
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(16, 16, 26, 0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background: var(--card-back-bg); padding: 2rem 3rem; border-radius: 10px; border: 1px solid var(--neon-cyan); box-shadow: 0 0 25px rgba(0, 255, 255, 0.5); position: relative; text-align: center; }
        .modal-content.danger { border-color: var(--neon-red); box-shadow: 0 0 25px rgba(255, 27, 27, 0.5); }
        .modal-title-danger { color: var(--neon-red); text-shadow: 0 0 10px var(--neon-red); margin-bottom: 1rem; font-size: 2rem;}
        .modal-text { max-width: 400px; line-height: 1.6; margin-bottom: 2rem; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        .modal-close-btn { position: absolute; top: 0.5rem; right: 1rem; font-size: 2rem; color: var(--primary-text); cursor: pointer; border: none; background: none; }
        .hof-explanation { font-size: 1rem; text-align: center; color: var(--primary-text); opacity: 0.8; max-width: 500px; margin-bottom: 1.5rem; line-height: 1.5; }
        .hof-table { width: 100%; min-width: 500px; border-collapse: collapse; margin-top: 1rem; }
        .hof-table th, .hof-table td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid rgba(0, 255, 255, 0.2); }
        .hof-table th { font-size: 1.2rem; color: var(--neon-cyan); text-transform: uppercase; }
        .hof-table td { font-size: 1.1rem; font-family: var(--font-mono); }
        .hof-table td.rank { text-align: center; color: var(--neon-yellow); }
        .hof-table td.time { text-align: right; color: var(--neon-green); }
        .hof-table td.invalid { text-align: right; color: var(--neon-red); }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Screens -->
        <div id="preloader-screen" class="screen active"><div class="atom"><div class="electron"></div><div class="electron"></div><div class="electron"></div></div><p class="loading-text">GENERANDO UNIVERSO MATEMÁTICO...</p><p id="loading-percentage" class="loading-text"></p></div>
        <div id="welcome-screen" class="screen"><h1 class="title">MISIÓN MATEMÁTICA</h1><button id="start-mission-btn" class="neon-button">INICIAR MISIÓN</button></div>
        <div id="profile-select-screen" class="screen"><h1 id="profile-select-title" class="title clickable">¿QUIÉN JUEGA?</h1><div id="profile-list" class="profile-list"></div></div>
        <div id="name-input-screen" class="screen"><div id="back-to-profiles-from-name-btn" class="back-button">&#10094; Volver a Perfiles</div><div class="name-input-container"><h2 class="prompt-text">REGISTRO DE EXPLORADOR:</h2><div id="player-name-display" class="name-display">_</div></div><div id="virtual-keyboard" class="keyboard-grid"></div></div>
        <div id="mission-select-screen" class="screen"><div id="back-to-profiles-btn" class="back-button">&#10094; Cambiar Explorador</div><div class="mission-header"><h1 class="title">MAPA ESTELAR</h1><div id="welcome-back-container"></div></div><h2 class="subtitle">SELECCIONA UNA OPERACIÓN</h2><div id="mission-selection-container" class="mission-selection-container"></div></div>
        <div id="sublevel-select-screen" class="screen"><div id="back-to-missions-btn" class="back-button">&#10094; Volver al Mapa Estelar</div><div id="sublevel-title-container"><h1 id="sublevel-title" class="title"></h1><button id="sublevel-hof-button" title="Ver Récords del Sector"><svg viewBox="0 0 24 24"><path d="M19 2H5C3.9 2 3 2.9 3 4V6C4.1 6 5 6.9 5 8C5 9.1 4.1 10 3 10V12C4.1 12 5 12.9 5 14C5 15.1 4.1 16 3 16V18C3 19.1 3.9 20 5 20H19C20.1 20 21 19.1 21 18V4C21 2.9 20.1 2 19 2M12 15L10.6 16.8L8 14.6L9.9 12.2L7 11.9V9.1L9.9 8.8L8 6.4L10.6 4.2L12 6L13.4 4.2L16 6.4L14.1 8.8L17 9.1V11.9L14.1 12.2L16 14.6L13.4 16.8L12 15Z"></path></svg></button></div><div id="bonus-time-display"></div><div id="sublevel-grid" class="sublevel-grid"></div></div>
        <div id="game-screen" class="screen"><div class="status-bar"><div id="status-player">Explorador:</div><div id="status-pairs">Pares: 0 / 0</div><div id="status-timer">00:00</div><div class="time-bar-container"><div id="time-bar"></div></div></div><div id="game-board" class="board-grid"></div></div>
        <div id="summary-screen" class="screen"><h1 id="summary-title" class="title"></h1><div id="summary-subtitle-container"></div><div id="summary-buttons" class="summary-buttons"></div></div>
        
        <!-- Modal Overlay -->
        <div id="modal-overlay" class="modal-overlay">
            <div id="modal-content" class="modal-content"></div>
        </div>
    </div>
<script>
const MathMission = {
    // --- STATE MANAGEMENT ---
    state: {
        allProfiles: [],
        currentPlayer: null,
        currentScreen: 'preloader',
        isShiftActive: false,
        selectedMissionId: null,
        selectedSublevel: null,
        timeBonus: 0,
        resetClickCount: 0,
        resetClickTimer: null,
        game: { lockBoard:false, firstCard:null, secondCard:null, pairsFound:0, totalPairs:0, timerId:null, timeLeft:0, totalTime:0, currentStreak:0, },
    },

    // --- CONFIGURATION ---
    config: {
        missions: {
            addition:       { name: 'Sumas', op: 'Σ' },
            subtraction:    { name: 'Restas', op: '-' },
            multiplication: { name: 'Multiplicación', op: '×' }
        },
        missionLevels: 10,
        streakBonusTime: 2,
        resetClickTarget: 5,
        storageKeys: { 
            profiles: 'matematica_profiles_v8',
            hallOfFame: 'matematica_hof_v8' 
        },
        secretSalt: 'Th3M4thN30nUn1v3rs3',
    },

    // --- UI ELEMENTS & METHODS ---
    ui: {
        elements: {}, 
        
        cacheElements() {
            this.elements = {
                appContainer: document.getElementById('app-container'),
                preloaderScreen: document.getElementById('preloader-screen'),
                welcomeScreen: document.getElementById('welcome-screen'),
                profileSelectScreen: document.getElementById('profile-select-screen'),
                nameInputScreen: document.getElementById('name-input-screen'),
                missionSelectScreen: document.getElementById('mission-select-screen'),
                sublevelSelectScreen: document.getElementById('sublevel-select-screen'),
                gameScreen: document.getElementById('game-screen'),
                summaryScreen: document.getElementById('summary-screen'),
                loadingPercentage: document.getElementById('loading-percentage'),
                startButton: document.getElementById('start-mission-btn'),
                profileSelectTitle: document.getElementById('profile-select-title'),
                profileList: document.getElementById('profile-list'),
                nameDisplay: document.getElementById('player-name-display'),
                keyboardContainer: document.getElementById('virtual-keyboard'),
                backToProfilesBtn: document.getElementById('back-to-profiles-btn'),
                backToProfilesFromNameBtn: document.getElementById('back-to-profiles-from-name-btn'),
                welcomeBackContainer: document.getElementById('welcome-back-container'),
                missionContainer: document.getElementById('mission-selection-container'),
                sublevelTitle: document.getElementById('sublevel-title'),
                sublevelHofButton: document.getElementById('sublevel-hof-button'),
                sublevelGrid: document.getElementById('sublevel-grid'),
                backToMissionsBtn: document.getElementById('back-to-missions-btn'),
                playerNameStatus: document.getElementById('status-player'),
                pairsStatus: document.getElementById('status-pairs'),
                timerStatus: document.getElementById('status-timer'),
                timeBar: document.getElementById('time-bar'),
                gameBoard: document.getElementById('game-board'),
                summaryTitle: document.getElementById('summary-title'),
                summarySubtitleContainer: document.getElementById('summary-subtitle-container'),
                summaryButtons: document.getElementById('summary-buttons'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalContent: document.getElementById('modal-content'),
            };
        },
        
        navigateTo(screenKey) {
            MathMission.state.currentScreen = screenKey;
            const screenName = screenKey + 'Screen';
            for (const key in this.elements) {
                if (key.endsWith('Screen')) this.elements[key].classList.remove('active');
            }
            if (this.elements[screenName]) this.elements[screenName].classList.add('active');
        },
        
        renderProfileList() {
            const { profileList } = this.elements;
            profileList.innerHTML = '';
            
            MathMission.state.allProfiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.dataset.name = profile.name;
                let progressHTML = '';
                for(const missionId in MathMission.config.missions) {
                    const mission = MathMission.config.missions[missionId];
                    const level = profile.progress[missionId];
                    progressHTML += `<div class="profile-progress-item"><span class="op-symbol">${mission.op}</span><span class="level-number">${level}</span></div>`;
                }
                card.innerHTML = `<div class="profile-name">${profile.name}</div><div class="profile-progress-summary">${progressHTML}</div>`;
                profileList.appendChild(card);
            });

            const addCard = document.createElement('div');
            addCard.className = 'profile-add-card';
            addCard.innerHTML = `<div class="plus-sign">+</div>`;
            profileList.appendChild(addCard);
        },

        showResetConfirmationModal() {
            const { modalContent, modalOverlay } = this.elements;
            modalContent.innerHTML = `
                <h2 class="modal-title-danger">ALERTA MÁXIMA</h2>
                <p class="modal-text">¿Estás absolutamente seguro de que quieres borrar TODOS los perfiles de explorador? Esta acción es PERMANENTE y no se puede deshacer.</p>
                <div class="modal-buttons">
                    <button class="neon-button danger" id="confirm-reset-btn">SÍ, ELIMINAR TODO</button>
                    <button class="neon-button" id="cancel-reset-btn">CANCELAR</button>
                </div>
            `;
            modalContent.classList.add('danger');
            modalOverlay.classList.add('visible');

            document.getElementById('confirm-reset-btn').addEventListener('click', () => {
                MathMission.handlers.executeReset();
                this.hideModal();
            });
            document.getElementById('cancel-reset-btn').addEventListener('click', () => this.hideModal());
        },

        hideModal() {
            this.elements.modalContent.innerHTML = '';
            this.elements.modalContent.classList.remove('danger');
            this.elements.modalOverlay.classList.remove('visible');
        },
        
        generateKeyboard() {
            const layout = [
                ['1','2','3','4','5','6','7','8','9','0'],
                ['A','B','C','D','E','F','G','H','I','J'],
                ['K','L','M','N','O','P','Q','R','S','@'],
                ['SHIFT','T','U','V','W','X','Y','Z','_','DEL'],
                ['SPACE', 'OK']
            ];
            this.elements.keyboardContainer.innerHTML = '';
            layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                row.forEach(keyText => {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key';
                    keyDiv.dataset.key = keyText === 'SPACE' ? ' ' : keyText;
                    keyDiv.textContent = keyText === 'SPACE' ? '' : keyText;
                    if (/^[A-Z]$/.test(keyText)) keyDiv.dataset.keyType = 'letter';
                    if (['SHIFT', 'DEL', 'OK'].includes(keyText)) keyDiv.classList.add('key-action');
                    if (keyText === 'SHIFT') keyDiv.classList.add('key-shift');
                    if (keyText === 'SPACE') keyDiv.classList.add('key-space');
                    if (['DEL', 'OK'].includes(keyText)) keyDiv.classList.add('key-double');
                    rowDiv.appendChild(keyDiv);
                });
                this.elements.keyboardContainer.appendChild(rowDiv);
            });
        },

        toggleShift(isActive) {
            MathMission.state.isShiftActive = isActive;
            document.querySelector('.key-shift').classList.toggle('active', isActive);
            document.querySelectorAll('.key[data-key-type="letter"]').forEach(key => {
                key.style.textTransform = isActive ? 'uppercase' : 'lowercase';
            });
        },
        
        updateTimerUI() {
            const { timeLeft, totalTime } = MathMission.state.game;
            const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
            const seconds = String(timeLeft % 60).padStart(2, '0');
            this.elements.timerStatus.textContent = `${minutes}:${seconds}`;
            const percentage = Math.max(0, (timeLeft / totalTime) * 100);
            this.elements.timeBar.style.width = `${percentage}%`;
            this.elements.timeBar.classList.remove('pulsing');
            this.elements.timerStatus.classList.remove('pulsing');
            if (percentage <= 25) {
                this.elements.timeBar.style.backgroundColor = 'var(--neon-red)';
                if (timeLeft <= 10) {
                    this.elements.timeBar.classList.add('pulsing');
                    this.elements.timerStatus.classList.add('pulsing');
                }
            } else if (percentage <= 50) {
                this.elements.timeBar.style.backgroundColor = 'var(--neon-yellow)';
            } else {
                this.elements.timeBar.style.backgroundColor = 'var(--neon-green)';
            }
        },

        showTimeBonusFeedback() {
            const feedbackEl = document.createElement('div');
            feedbackEl.className = 'time-bonus-feedback';
            feedbackEl.textContent = `+${MathMission.config.streakBonusTime}s`;
            this.elements.appContainer.appendChild(feedbackEl);
            setTimeout(() => feedbackEl.remove(), 1500);
        },
        
        showRecordsModal(missionId) {
            const hof = MathMission.storage.getHallOfFame();
            const records = hof[missionId];
            const missionName = MathMission.config.missions[missionId].name;
            let contentHTML = `<h2 class="subtitle">Salón de la Fama: ${missionName}</h2><p class="hof-explanation">El Salón de la Fama registra los 5 tiempos más rápidos para completar <strong>todos los niveles</strong> de un sector. ¡Demuestra tu maestría para grabar tu nombre en la historia!</p><table class="hof-table"><thead><tr><th class="rank">#</th><th>Explorador</th><th class="time">Tiempo</th></tr></thead><tbody>`;
            if (records.length === 0) {
                contentHTML += `<tr><td colspan="3" style="text-align:center;">Aún no hay récords. ¡Sé el primero!</td></tr>`;
            } else {
                records.forEach((r, i) => {
                    const isValid = r.seal === MathMission.utils.simpleHash(r.name + r.time + MathMission.config.secretSalt);
                    const timeDisplay = isValid ? `${String(Math.floor(r.time / 60)).padStart(2, '0')}:${String(r.time % 60).padStart(2, '0')}` : '[Inválido]';
                    const timeClass = isValid ? 'time' : 'invalid';
                    contentHTML += `<tr><td class="rank">${i + 1}</td><td>${r.name}</td><td class="${timeClass}">${timeDisplay}</td></tr>`;
                });
            }
            contentHTML += `</tbody></table><button class="modal-close-btn">&times;</button>`;
            this.elements.modalContent.innerHTML = contentHTML;
            this.elements.modalOverlay.classList.add('visible');
            this.elements.modalContent.querySelector('.modal-close-btn').addEventListener('click', () => this.hideModal());
        },
    },

    // --- GAME LOGIC ---
    game: {
        start(sublevel) {
            MathMission.state.selectedSublevel = sublevel;
            this.resetState(sublevel);
            MathMission.ui.navigateTo('game');
            const problems = this.generateProblems(MathMission.state.selectedMissionId, sublevel);
            const cardValues = [];
            problems.forEach((p, i) => {
                cardValues.push({ value: p.problem, pairId: i, type: 'problem' });
                cardValues.push({ value: p.solution, pairId: i, type: 'solution' });
            });
            MathMission.utils.shuffle(cardValues);
            this.renderBoard(cardValues);
            this.startTimer();
        },

        resetState(sublevel) {
            const { state } = MathMission;
            const { game } = state;
            if (game.timerId) clearInterval(game.timerId);
            Object.assign(game, {
                lockBoard: false, firstCard: null, secondCard: null,
                pairsFound: 0, totalPairs: sublevel + 1, currentStreak: 0,
                totalTime: 20 + ((sublevel + 1) * 8) + state.timeBonus,
            });
            game.timeLeft = game.totalTime;
            state.timeBonus = 0;
            MathMission.ui.updateTimerUI();
        },

        generateProblems(missionId, level) {
            const problems = [];
            const solutions = new Set();
            const mission = MathMission.config.missions[missionId];
            const numProblems = level + 1;
            const maxNumber = 5 + (level * 2);
            while (problems.length < numProblems) {
                let n1, n2, problem, solution;
                switch (missionId) {
                    case 'addition': n1 = Math.floor(Math.random() * maxNumber) + 1; n2 = Math.floor(Math.random() * maxNumber) + 1; solution = n1 + n2; problem = `${n1} + ${n2}`; break;
                    case 'subtraction': n1 = Math.floor(Math.random() * maxNumber) + level + 1; n2 = Math.floor(Math.random() * (n1 - 1)) + 1; solution = n1 - n2; problem = `${n1} - ${n2}`; break;
                    case 'multiplication': const factor = Math.floor(level / 2) + 2; n1 = Math.floor(Math.random() * factor) + 1; n2 = Math.floor(Math.random() * factor) + 1; solution = n1 * n2; problem = `${n1} x ${n2}`; break;
                }
                if (!solutions.has(solution)) {
                    solutions.add(solution);
                    problems.push({ problem, solution });
                }
            }
            return problems;
        },

        renderBoard(cardValues) {
            const { gameBoard, pairsStatus } = MathMission.ui.elements;
            const totalCards = cardValues.length;
            const cols = Math.ceil(Math.sqrt(totalCards));
            const rows = Math.ceil(totalCards / cols);
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gameBoard.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            pairsStatus.textContent = `Pares: 0 / ${MathMission.state.game.totalPairs}`;
            const tempCard = document.createElement('div');
            tempCard.className = 'card';
            tempCard.innerHTML = `<div class="card-inner"><div class="card-face"></div><div class="card-face card-back"></div></div>`;
            gameBoard.appendChild(tempCard);
            const cardWidth = tempCard.clientWidth;
            const cardFaceStyle = getComputedStyle(tempCard.querySelector('.card-face'));
            const cardPadding = parseFloat(cardFaceStyle.paddingLeft) + parseFloat(cardFaceStyle.paddingRight);
            const availableWidth = cardWidth - cardPadding;
            const cardBackStyle = getComputedStyle(tempCard.querySelector('.card-back'));
            const defaultFontSize = parseFloat(cardBackStyle.fontSize);
            const defaultFontFamily = cardBackStyle.fontFamily;
            gameBoard.innerHTML = '';
            MathMission.utils.metricsContext.font = `${defaultFontSize}px ${defaultFontFamily}`;
            cardValues.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.pairId = item.pairId;
                card.innerHTML = `<div class="card-inner"><div class="card-face card-front"></div><div class="card-face card-back ${item.type}">${item.value}</div></div>`;
                const cardBack = card.querySelector('.card-back');
                const textMetrics = MathMission.utils.metricsContext.measureText(item.value);
                if (textMetrics.width > availableWidth) {
                    const newFontSize = (defaultFontSize * (availableWidth / textMetrics.width)) * 0.95;
                    cardBack.style.fontSize = `${newFontSize}px`;
                }
                gameBoard.appendChild(card);
            });
        },

        startTimer() {
            MathMission.state.game.timerId = setInterval(() => {
                MathMission.state.game.timeLeft--;
                MathMission.ui.updateTimerUI();
                if (MathMission.state.game.timeLeft <= 0) {
                    clearInterval(MathMission.state.game.timerId);
                    this.handleGameOver(false);
                }
            }, 1000);
        },

        handleGameOver(isWin) {
            if (MathMission.state.game.timerId) clearInterval(MathMission.state.game.timerId);
            MathMission.ui.navigateTo('summary');
            const { summaryTitle, summaryButtons, summarySubtitleContainer } = MathMission.ui.elements;
            summaryTitle.classList.toggle('summary-title-lost', !isWin);
            summaryButtons.innerHTML = '';
            summarySubtitleContainer.innerHTML = '';
            if (isWin) this.processWin(); else this.processLoss();
        },

        processWin() {
            const { state } = MathMission;
            state.timeBonus = state.game.timeLeft;
            const currentLevel = state.selectedSublevel;
            const missionId = state.selectedMissionId;
            if (currentLevel + 1 > state.currentPlayer.progress[missionId]) {
                state.currentPlayer.progress[missionId] = currentLevel + 1;
                MathMission.storage.saveAllProfiles();
            }
            MathMission.ui.elements.summaryTitle.textContent = 'MISIÓN CUMPLIDA';
            const isLastLevel = currentLevel === MathMission.config.missionLevels;
            if (isLastLevel) {
                const timeTaken = state.game.totalTime - state.game.timeLeft;
                this.checkAndSetNewRecord(missionId, timeTaken);
            }
            const nextButtonHTML = isLastLevel ? `<button class="neon-button" id="mission-complete-btn">VOLVER AL MAPA</button>`:`<button class="neon-button" id="next-level-btn">SIGUIENTE NIVEL</button>`;
            const mapButtonHTML = `<button class="neon-button" id="map-btn">MAPA DEL SECTOR</button>`;
            MathMission.ui.elements.summaryButtons.innerHTML = nextButtonHTML + mapButtonHTML;
            if (isLastLevel) {
                document.getElementById('mission-complete-btn').addEventListener('click', () => MathMission.handlers.renderSublevelMap(missionId));
            } else {
                document.getElementById('next-level-btn').addEventListener('click', () => this.start(currentLevel + 1));
            }
            document.getElementById('map-btn').addEventListener('click', () => MathMission.handlers.renderSublevelMap(missionId));
        },

        processLoss() {
            MathMission.state.timeBonus = 0;
            MathMission.ui.elements.summaryTitle.textContent = 'TIEMPO AGOTADO';
            const retryButtonHTML = `<button class="neon-button" id="retry-btn">REINTENTAR NIVEL</button>`;
            const mapButtonHTML = `<button class="neon-button" id="map-btn">MAPA DEL SECTOR</button>`;
            MathMission.ui.elements.summaryButtons.innerHTML = retryButtonHTML + mapButtonHTML;
            document.getElementById('retry-btn').addEventListener('click', () => this.start(MathMission.state.selectedSublevel));
            document.getElementById('map-btn').addEventListener('click', () => MathMission.handlers.renderSublevelMap(MathMission.state.selectedMissionId));
        },

        checkAndSetNewRecord(missionId, timeTaken) {
            const hof = MathMission.storage.getHallOfFame();
            const newRecord = { name: MathMission.state.currentPlayer.name, time: timeTaken, seal: MathMission.utils.simpleHash(MathMission.state.currentPlayer.name + timeTaken + MathMission.config.secretSalt) };
            const missionHof = hof[missionId] || [];
            const newHof = [...missionHof, newRecord].sort((a, b) => a.time - b.time).slice(0, 5);
            if (JSON.stringify(newHof) !== JSON.stringify(missionHof)) {
                hof[missionId] = newHof;
                MathMission.storage.saveHallOfFame(hof);
                MathMission.ui.elements.summarySubtitleContainer.innerHTML = `<h2 id="new-record-subtitle">¡NUEVO RÉCORD DEL SECTOR!</h2>`;
            }
        },
    },

    // --- EVENT HANDLERS ---
    handlers: {
        onStartMissionClick() {
            MathMission.utils.activateFullscreen();
            MathMission.state.allProfiles = MathMission.storage.getAllProfiles();
            MathMission.ui.renderProfileList();
            MathMission.ui.navigateTo('profileSelect');
        },
        
        onProfileSelect(name) {
            const profile = MathMission.state.allProfiles.find(p => p.name === name);
            if (profile) {
                MathMission.state.currentPlayer = profile;
                this.setupMissionSelectScreen();
                this.generateMissionButtons();
                MathMission.ui.navigateTo('missionSelect');
            }
        },

        onKeyPress(key) {
            if (key === 'SHIFT') { MathMission.ui.toggleShift(!MathMission.state.isShiftActive); return; }
            let currentName = MathMission.ui.elements.nameDisplay.textContent.trim();
            if (currentName === '_') currentName = '';
            
            if (key === 'DEL') { currentName = currentName.slice(0, -1); } 
            else if (key === 'OK') {
                if (currentName.length > 0 && !MathMission.state.allProfiles.some(p => p.name.toLowerCase() === currentName.toLowerCase())) {
                    const newProfile = { name: currentName, progress: MathMission.utils.createDefaultProgress() };
                    MathMission.state.allProfiles.push(newProfile);
                    MathMission.storage.saveAllProfiles();
                    this.onProfileSelect(currentName);
                }
                return;
            } else { if (currentName.length < 12) { currentName += MathMission.state.isShiftActive ? key.toUpperCase() : key.toLowerCase(); } }
            
            MathMission.ui.elements.nameDisplay.textContent = currentName.length > 0 ? currentName : '_';
            if (MathMission.state.isShiftActive && key !== ' ' && key.length === 1) { MathMission.ui.toggleShift(false); }
        },
        
        handleResetTrigger() {
            const state = MathMission.state;
            clearTimeout(state.resetClickTimer);
            state.resetClickCount++;
            if (state.resetClickCount >= MathMission.config.resetClickTarget) {
                MathMission.ui.showResetConfirmationModal();
                state.resetClickCount = 0;
            }
            state.resetClickTimer = setTimeout(() => { state.resetClickCount = 0; }, 1000);
        },

        executeReset() {
            MathMission.storage.deleteAllData();
            MathMission.state.allProfiles = [];
            MathMission.state.currentPlayer = null;
            MathMission.ui.renderProfileList();
        },
        
        onCardClick(event) {
            const card = event.target.closest('.card');
            const game = MathMission.state.game;
            if (!card || game.lockBoard || card === game.firstCard || card.classList.contains('matched')) return;
            card.classList.add('flipped');
            if (!game.firstCard) { game.firstCard = card; return; }
            game.secondCard = card;
            game.lockBoard = true;
            const isMatch = game.firstCard.dataset.pairId === game.secondCard.dataset.pairId;
            setTimeout(() => { if (isMatch) this.processMatch(); else this.processMismatch(); }, 600);
        },

        processMatch() {
            const game = MathMission.state.game;
            game.currentStreak++;
            if (game.currentStreak >= 2) {
                const bonus = MathMission.config.streakBonusTime;
                game.timeLeft += bonus;
                game.totalTime += bonus;
                MathMission.ui.showTimeBonusFeedback();
                MathMission.ui.updateTimerUI();
            }
            setTimeout(() => {
                game.firstCard.classList.add('matched');
                game.secondCard.classList.add('matched');
                game.pairsFound++;
                MathMission.ui.elements.pairsStatus.textContent = `Pares: ${game.pairsFound} / ${game.totalPairs}`;
                if (game.pairsFound === game.totalPairs) {
                    setTimeout(() => MathMission.game.handleGameOver(true), 800);
                } else {
                    [game.firstCard, game.secondCard] = [null, null];
                    game.lockBoard = false;
                }
            }, 400);
        },

        processMismatch() {
            const game = MathMission.state.game;
            game.currentStreak = 0;
            game.firstCard.classList.add('mismatched');
            game.secondCard.classList.add('mismatched');
            setTimeout(() => {
                game.firstCard.classList.remove('flipped', 'mismatched');
                game.secondCard.classList.remove('flipped', 'mismatched');
                [game.firstCard, game.secondCard] = [null, null];
                game.lockBoard = false;
            }, 1200);
        },

        setupMissionSelectScreen() {
            const { name } = MathMission.state.currentPlayer;
            const { playerNameStatus, welcomeBackContainer } = MathMission.ui.elements;
            playerNameStatus.textContent = `Explorador: ${name}`;
            welcomeBackContainer.innerHTML = `<p class="welcome-back-message">Misiones para ${name}</p>`;
        },
        
        generateMissionButtons() {
            const { missionContainer } = MathMission.ui.elements;
            missionContainer.innerHTML = '';
            for (const missionId in MathMission.config.missions) {
                const mission = MathMission.config.missions[missionId];
                const button = document.createElement('div');
                button.className = 'mission-button';
                button.dataset.missionId = missionId;
                button.innerHTML = `<h3>${mission.name}</h3>`;
                missionContainer.appendChild(button);
            }
        },

        renderSublevelMap(missionId) {
            MathMission.state.selectedMissionId = missionId;
            const mission = MathMission.config.missions[missionId];
            const { sublevelTitle, sublevelGrid } = MathMission.ui.elements;
            sublevelTitle.textContent = `SECTOR: ${mission.name.toUpperCase()}`;
            sublevelGrid.innerHTML = '';
            for (let i = 1; i <= MathMission.config.missionLevels; i++) {
                const node = document.createElement('div');
                node.className = 'sublevel-node';
                node.textContent = i;
                node.dataset.level = i;
                if (i > MathMission.state.currentPlayer.progress[missionId]) node.classList.add('locked');
                sublevelGrid.appendChild(node);
            }
            MathMission.ui.navigateTo('sublevelSelect');
        }
    },
    
    // --- UTILITIES & STORAGE ---
    utils: {
        metricsContext: (() => { const c = document.createElement('canvas'); return c.getContext('2d');})(),
        activateFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen().catch(err => {});
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        },
        simpleHash(str) { let h = 0; for (let i = 0; i < str.length; i++) { h = ((h << 5) - h) + str.charCodeAt(i); h |= 0; } return h; },
        shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } },
        createDefaultProgress() {
            const progress = {};
            for (const missionId in MathMission.config.missions) {
                progress[missionId] = 1;
            }
            return progress;
        }
    },

    storage: {
        getAllProfiles() { return JSON.parse(localStorage.getItem(MathMission.config.storageKeys.profiles)) || []; },
        saveAllProfiles() { localStorage.setItem(MathMission.config.storageKeys.profiles, JSON.stringify(MathMission.state.allProfiles)); },
        getHallOfFame() {
            const data = localStorage.getItem(MathMission.config.storageKeys.hallOfFame);
            let hof = data ? JSON.parse(data) : {};
            for (const key in MathMission.config.missions) { if (!hof[key]) hof[key] = []; }
            return hof;
        },
        saveHallOfFame(hof) { localStorage.setItem(MathMission.config.storageKeys.hallOfFame, JSON.stringify(hof)); },
        deleteAllData() {
            localStorage.removeItem(MathMission.config.storageKeys.profiles);
            localStorage.removeItem(MathMission.config.storageKeys.hallOfFame);
        }
    },

    // --- INITIALIZATION ---
    init: {
        run() {
            MathMission.ui.cacheElements();
            MathMission.ui.generateKeyboard();
            this.addEventListeners();
            this.runPreloaderAnimation();
        },
        addEventListeners() {
            const { elements } = MathMission.ui;
            const { handlers } = MathMission;
            
            elements.startButton.addEventListener('click', () => handlers.onStartMissionClick());
            
            elements.profileSelectTitle.addEventListener('click', () => handlers.handleResetTrigger());
            
            elements.profileList.addEventListener('click', e => {
                const profileCard = e.target.closest('.profile-card');
                const addCard = e.target.closest('.profile-add-card');
                if (profileCard) handlers.onProfileSelect(profileCard.dataset.name);
                else if (addCard) {
                    elements.nameDisplay.textContent = '_';
                    MathMission.ui.navigateTo('nameInput');
                }
            });

            const backToProfiles = () => {
                MathMission.ui.renderProfileList();
                MathMission.ui.navigateTo('profileSelect');
            };
            elements.backToProfilesBtn.addEventListener('click', backToProfiles);
            elements.backToProfilesFromNameBtn.addEventListener('click', backToProfiles);

            elements.keyboardContainer.addEventListener('click', e => { if(e.target.classList.contains('key')) handlers.onKeyPress(e.target.dataset.key); });
            elements.missionContainer.addEventListener('click', e => { const mBtn = e.target.closest('.mission-button'); if (mBtn) handlers.renderSublevelMap(mBtn.dataset.missionId); });
            elements.sublevelGrid.addEventListener('click', e => { const sNode = e.target.closest('.sublevel-node'); if (sNode && !sNode.classList.contains('locked')) MathMission.game.start(parseInt(sNode.dataset.level)); });
            elements.backToMissionsBtn.addEventListener('click', () => MathMission.ui.navigateTo('missionSelect'));
            elements.gameBoard.addEventListener('click', e => handlers.onCardClick(e));
            elements.sublevelHofButton.addEventListener('click', () => MathMission.ui.showRecordsModal(MathMission.state.selectedMissionId));
            elements.modalOverlay.addEventListener('click', e => { if (e.target === elements.modalOverlay) MathMission.ui.hideModal(); });
        },
        runPreloaderAnimation() {
            let p = 0; const iT = 25; const tT = 1500; const inc = (iT / tT) * 100;
            const iId = setInterval(() => {
                p += inc;
                if (p >= 100) {
                    p = 100;
                    MathMission.ui.elements.loadingPercentage.textContent = `${Math.floor(p)}%`;
                    clearInterval(iId);
                    setTimeout(() => MathMission.ui.navigateTo('welcome'), 200);
                } else {
                    MathMission.ui.elements.loadingPercentage.textContent = `${Math.floor(p)}%`;
                }
            }, iT);
        }
    }
};

document.addEventListener('DOMContentLoaded', () => MathMission.init.run());
</script>
</body>
</html>